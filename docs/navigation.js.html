<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>navigation.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Blacklist.html">Blacklist</a><ul class='methods'><li data-type='method'><a href="Blacklist.html#blacklistUser">blacklistUser</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklisted">isUserBlacklisted</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklistedQuick">isUserBlacklistedQuick</a></li><li data-type='method'><a href="Blacklist.html#unblacklistUser">unblacklistUser</a></li></ul></li><li><a href="Command.html">Command</a></li><li><a href="CommandManager.html">CommandManager</a><ul class='methods'><li data-type='method'><a href="CommandManager.html#getHelpCommandHelper">getHelpCommandHelper</a></li></ul></li><li><a href="HelpCommandHelper.html">HelpCommandHelper</a><ul class='methods'><li data-type='method'><a href="HelpCommandHelper.html#findCommand">findCommand</a></li><li data-type='method'><a href="HelpCommandHelper.html#getEnabledNonHiddenCommands">getEnabledNonHiddenCommands</a></li><li data-type='method'><a href="HelpCommandHelper.html#getNonHiddenCommands">getNonHiddenCommands</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#logFailure">logFailure</a></li><li data-type='method'><a href="Logger.html#logSuccess">logSuccess</a></li></ul></li><li><a href="MessageProcessor.html">MessageProcessor</a></li><li><a href="Monochrome.html">Monochrome</a><ul class='methods'><li data-type='method'><a href="Monochrome.html#connect">connect</a></li><li data-type='method'><a href="Monochrome.html#getBlacklist">getBlacklist</a></li><li data-type='method'><a href="Monochrome.html#getCommandManager">getCommandManager</a></li><li data-type='method'><a href="Monochrome.html#getErisBot">getErisBot</a></li><li data-type='method'><a href="Monochrome.html#getLogger">getLogger</a></li><li data-type='method'><a href="Monochrome.html#getNavigationManager">getNavigationManager</a></li><li data-type='method'><a href="Monochrome.html#getPersistence">getPersistence</a></li><li data-type='method'><a href="Monochrome.html#getSettings">getSettings</a></li><li data-type='method'><a href="Monochrome.html#reload">reload</a></li><li data-type='method'><a href="Monochrome.html#stop">stop</a></li><li data-type='method'><a href="Monochrome.html#userIsServerAdmin">userIsServerAdmin</a></li></ul></li><li><a href="Navigation.html">Navigation</a><ul class='methods'><li data-type='method'><a href="Navigation.html#.fromOneDimensionalContents">fromOneDimensionalContents</a></li><li data-type='method'><a href="Navigation.html#.fromOneNavigationChapter">fromOneNavigationChapter</a></li></ul></li><li><a href="NavigationChapter.html">NavigationChapter</a><ul class='methods'><li data-type='method'><a href="NavigationChapter.html#.fromContent">fromContent</a></li></ul></li><li><a href="NavigationManager.html">NavigationManager</a><ul class='methods'><li data-type='method'><a href="NavigationManager.html#show">show</a></li></ul></li><li><a href="Persistence.html">Persistence</a><ul class='methods'><li data-type='method'><a href="Persistence.html#editData">editData</a></li><li data-type='method'><a href="Persistence.html#editDataForServer">editDataForServer</a></li><li data-type='method'><a href="Persistence.html#editDataForUser">editDataForUser</a></li><li data-type='method'><a href="Persistence.html#editGlobalData">editGlobalData</a></li><li data-type='method'><a href="Persistence.html#editPrefixesForServerId">editPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#getData">getData</a></li><li data-type='method'><a href="Persistence.html#getDataForServer">getDataForServer</a></li><li data-type='method'><a href="Persistence.html#getDataForUser">getDataForUser</a></li><li data-type='method'><a href="Persistence.html#getGlobalData">getGlobalData</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForMessage">getPrefixesForMessage</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForServer">getPrefixesForServer</a></li><li data-type='method'><a href="Persistence.html#getPrimaryPrefixForMessage">getPrimaryPrefixForMessage</a></li><li data-type='method'><a href="Persistence.html#resetPrefixesForServerId">resetPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#stop">stop</a></li></ul></li><li><a href="Settings.html">Settings</a><ul class='methods'><li data-type='method'><a href="Settings.html#getInternalSettingValue">getInternalSettingValue</a></li><li data-type='method'><a href="Settings.html#getRawSettingsTree">getRawSettingsTree</a></li><li data-type='method'><a href="Settings.html#getTreeNodeForUniqueId">getTreeNodeForUniqueId</a></li><li data-type='method'><a href="Settings.html#getUserFacingSettingValue">getUserFacingSettingValue</a></li><li data-type='method'><a href="Settings.html#setChannelSettingValue">setChannelSettingValue</a></li><li data-type='method'><a href="Settings.html#setServerWideSettingValue">setServerWideSettingValue</a></li><li data-type='method'><a href="Settings.html#setUserSettingValue">setUserSettingValue</a></li><li data-type='method'><a href="Settings.html#userFacingValueIsValidForSetting">userFacingValueIsValidForSetting</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-_Eris.Client_.html">Eris.Client</a></li><li><a href="external-_Eris.Message_.html">Eris.Message</a></li><li><a href="external-_Eris.TextChannel_.html">Eris.TextChannel</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">navigation.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const NavigationChapter = require('./navigation_chapter.js');

const LOGGER_TITLE = 'NAVIGATION';
const EDIT_DELAY_TIME_IN_MS = 1500;

function sendReactions(msg, reactions, logger) {
  let promise = Promise.resolve();
  for (let reaction of reactions) {
    promise = promise.then(() => {
      return msg.channel.addMessageReaction(msg.id, reaction);
    }).catch(err => {
      logger.logFailure(LOGGER_TITLE, 'Failed to add reaction button to navigation', err);
    });
  }
}

/**
 * Represents a collection of messages that can be navigated in two dimensions
 * via reaction buttons below the message. A navigation is a collection of {@link NavigationChapter}s.
 * Each navigation chapter controls a one-dimensional slice of navigable content.
 * The user can move forward and backward within a chapter by using the arrow reaction
 * buttons, and can switch chapters by using the other reaction buttons.&lt;br>&lt;br>
 * Once a Navigation is constructed, it can be shown to the user by using {@link NavigationManager#show}.
 * For an example of creating a navigation, see the [demo navigation command]{@link https://github.com/mistval/monochrome-demo/blob/master/commands/navigation.js}.
 */
class Navigation {
  /**
  * Construct a Navigation. If this Navigation only has one {@link NavigationChapter}, use the
  * {@link Navigation.fromOneNavigationChapter} factory method instead. If you only
  * need left and right pagination, and you already have all the content you want to display
  * to the user, use the {@link Navigation.fromOneDimensionalContents} factory method instead.
  * @param {string} ownerId - The user ID of the user who is allowed to use the reaction buttons to navigate.
  * @param {boolean} showPageArrows - Whether to show the arrow reactions or not. If you know in advance
  *   that none of your {@link NavigationChapter}s have more than one page, you can set this to false.
  * @param {string} initialEmojiName - The name of the emoji for the chapter to show initially.
  * @param {Object.&lt;string, NavigationChapter>} chapterForEmojiName - An object where the keys are emoji names and the values are {@link NavigationChapter}s.
  *   When the emoji is clicked, control will switch to the specified chapter. To find the name of an emoji, enter the emoji in
  *   Discord's chat box, put a \ in front of it, and hit enter.
  */
  constructor(ownerId, showPageArrows, initialEmojiName, chapterForEmojiName) {
    let keys = Object.keys(chapterForEmojiName);
    if (keys.indexOf(initialEmojiName) === -1) {
      throw new Error('Value of initialEmojiName not found in chapterForEmojiName');
    }
    this.showPageArrows_ = showPageArrows;
    this.chapterForEmojiName_ = chapterForEmojiName;
    this.currentEmojiName_ = initialEmojiName;
    this.ownerId_ = ownerId;
    this.actionAccumulator_ = new ActionAccumulator(EDIT_DELAY_TIME_IN_MS);
  }

  /**
   * Construct a Navigation with just one chapter. Only the arrow reactions will
   * be shown and navigation will only be possible in one dimension.
   * If you already have all the content you want to display to the user,
   * you can use the {@link Navigation.fromOneDimensionalContents} factory method instead
   * and avoid having to construct a {@link NavigationChapter} yourself.
   * @param {string} ownerId - The user ID of the user who is allowed to use the reaction buttons to navigate.
   * @param {NavigationChapter} navigationChapter - The {@link NavigationChapter} to show.
   * @param {boolean} showPageArrows - Whether to show the page arrows or not.
   */
  static fromOneNavigationChapter(ownerId, navigationChapter, showPageArrows=true) {
    const chapterForEmojiName = { a: navigationChapter };
    return new Navigation(ownerId, showPageArrows, 'a', chapterForEmojiName);
  }

  /**
   * Construct a Navigation from an array of [Discord embed structures]{@link https://discordapp.com/developers/docs/resources/channel#embed-object} (or strings).
   * Only the arrow reactions will be shown and navigation will only be possible in one dimension.
   * @param {string} ownerId - The user ID of the user who is allowed to use the reaction buttons to navigate.
   * @param {string[]|Object[]} contents - The strings or [Discord embed structures]{@link https://discordapp.com/developers/docs/resources/channel#embed-object}
   *   to show in the navigation.
   */
  static fromOneDimensionalContents(ownerId, contents) {
    const chapter = NavigationChapter.fromContent(contents);
    return Navigation.fromOneNavigationChapter(ownerId, chapter, contents.length > 1);
  }

  createMessage(channel, parentMsg, logger) {
    let chapter = this.getChapterForEmojiName_(this.currentEmojiName_);
    return chapter.getCurrentPage(logger).then(navigationPage => {
      if (!navigationPage) {
        throw new Error('Navigation failed to create initial page.');
      }
      if (navigationPage.showPageArrows !== undefined) {
        this.showPageArrows_ = navigationPage.showPageArrows;
      }
      return channel.createMessage(navigationPage, undefined, parentMsg);
    }).then(sentMessage => {
      let emojis = Object.keys(this.chapterForEmojiName_);
      let reactionsToSend = [];
      if (emojis.length > 1) {
        reactionsToSend = reactionsToSend.concat(emojis);
      }

      if (this.showPageArrows_) {
        reactionsToSend.push('⬅');
        reactionsToSend.push('➡');
      }

      sendReactions(sentMessage, reactionsToSend, logger);
      this.message_ = sentMessage;
      return sentMessage.id;
    }).catch(err => {
      logger.logFailure(LOGGER_TITLE, 'Failed to create navigation.', err);
      throw err;
    });
  }

  handleEmojiToggled(bot, emoji, userId, logger) {
    if (bot.user.id === userId) {
      return;
    } else if (emoji.name === this.currentEmojiName_) {
      return;
    } else if (userId !== this.ownerId_) {
      return;
    }

    this.actionAccumulator_.enqueue(() => {
      let pagePromise = undefined;
      let desiredEmojiName = emoji.name;

      if (this.showPageArrows_ &amp;&amp; emoji.name === '⬅') {
        pagePromise = this.getChapterForEmojiName_(this.currentEmojiName_).flipToPreviousPage(logger);
        desiredEmojiName = this.currentEmojiName_;
      } else if (this.showPageArrows_ &amp;&amp; emoji.name === '➡') {
        pagePromise = this.getChapterForEmojiName_(this.currentEmojiName_).flipToNextPage(logger);
        desiredEmojiName = this.currentEmojiName_;
      } else {
        let chapter = this.getChapterForEmojiName_(emoji.name);
        if (!chapter) {
          return;
        }
        this.currentEmojiName_ = emoji.name;
        pagePromise = chapter.getCurrentPage(logger);
      }

      pagePromise.then(navigationPage => {
        if (navigationPage &amp;&amp; desiredEmojiName === this.currentEmojiName_) {
          return this.message_.edit(navigationPage);
        }
      }).catch(err => {
        logger.logFailure(LOGGER_TITLE, 'Error navigating.', err);
      });
    });
  }

  getChapterForEmojiName_(emojiName) {
    let keys = Object.keys(this.chapterForEmojiName_);
    for (let key of keys) {
      if (key === emojiName) {
        return this.chapterForEmojiName_[key];
      }
    }

    return;
  }
}

class ActionAccumulator {
  constructor(delayInMs) {
    this.delayInMs_ = delayInMs;
    this.timerInFlight_ = false;
    this.callback_ = undefined;
  }

  enqueue(callback) {
    if (this.timerInFlight_) {
      this.callback_ = callback;
    } else {
      this.timerInFlight_ = true;
      callback();
      setTimeout(() => {
        this.timerInFlight_ = false;
        if (this.callback) {
          this.callback_();
          this.callback_ = undefined;
        }
      },
      this.delayInMs);
    }
  }
}

module.exports = Navigation;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Jan 23 2019 14:32:31 GMT+0700 (GMT+07:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
