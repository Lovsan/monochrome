<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>logger.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Blacklist.html">Blacklist</a><ul class='methods'><li data-type='method'><a href="Blacklist.html#blacklistUser">blacklistUser</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklisted">isUserBlacklisted</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklistedQuick">isUserBlacklistedQuick</a></li><li data-type='method'><a href="Blacklist.html#unblacklistUser">unblacklistUser</a></li></ul></li><li><a href="Command.html">Command</a></li><li><a href="CommandManager.html">CommandManager</a><ul class='methods'><li data-type='method'><a href="CommandManager.html#getHelpCommandHelper">getHelpCommandHelper</a></li></ul></li><li><a href="HelpCommandHelper.html">HelpCommandHelper</a><ul class='methods'><li data-type='method'><a href="HelpCommandHelper.html#findCommand">findCommand</a></li><li data-type='method'><a href="HelpCommandHelper.html#getEnabledNonHiddenCommands">getEnabledNonHiddenCommands</a></li><li data-type='method'><a href="HelpCommandHelper.html#getNonHiddenCommands">getNonHiddenCommands</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#logFailure">logFailure</a></li><li data-type='method'><a href="Logger.html#logSuccess">logSuccess</a></li></ul></li><li><a href="MessageProcessor.html">MessageProcessor</a></li><li><a href="Monochrome.html">Monochrome</a><ul class='methods'><li data-type='method'><a href="Monochrome.html#connect">connect</a></li><li data-type='method'><a href="Monochrome.html#getBlacklist">getBlacklist</a></li><li data-type='method'><a href="Monochrome.html#getCommandManager">getCommandManager</a></li><li data-type='method'><a href="Monochrome.html#getErisBot">getErisBot</a></li><li data-type='method'><a href="Monochrome.html#getLogger">getLogger</a></li><li data-type='method'><a href="Monochrome.html#getNavigationManager">getNavigationManager</a></li><li data-type='method'><a href="Monochrome.html#getPersistence">getPersistence</a></li><li data-type='method'><a href="Monochrome.html#getSettings">getSettings</a></li><li data-type='method'><a href="Monochrome.html#reload">reload</a></li><li data-type='method'><a href="Monochrome.html#stop">stop</a></li><li data-type='method'><a href="Monochrome.html#userIsServerAdmin">userIsServerAdmin</a></li><li data-type='method'><a href="Monochrome.html#waitForMessage">waitForMessage</a></li></ul></li><li><a href="Navigation.html">Navigation</a><ul class='methods'><li data-type='method'><a href="Navigation.html#.fromOneDimensionalContents">fromOneDimensionalContents</a></li><li data-type='method'><a href="Navigation.html#.fromOneNavigationChapter">fromOneNavigationChapter</a></li></ul></li><li><a href="NavigationChapter.html">NavigationChapter</a><ul class='methods'><li data-type='method'><a href="NavigationChapter.html#.fromContent">fromContent</a></li></ul></li><li><a href="NavigationManager.html">NavigationManager</a><ul class='methods'><li data-type='method'><a href="NavigationManager.html#show">show</a></li></ul></li><li><a href="Persistence.html">Persistence</a><ul class='methods'><li data-type='method'><a href="Persistence.html#editData">editData</a></li><li data-type='method'><a href="Persistence.html#editDataForServer">editDataForServer</a></li><li data-type='method'><a href="Persistence.html#editDataForUser">editDataForUser</a></li><li data-type='method'><a href="Persistence.html#editGlobalData">editGlobalData</a></li><li data-type='method'><a href="Persistence.html#editPrefixesForServerId">editPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#getData">getData</a></li><li data-type='method'><a href="Persistence.html#getDataForServer">getDataForServer</a></li><li data-type='method'><a href="Persistence.html#getDataForUser">getDataForUser</a></li><li data-type='method'><a href="Persistence.html#getGlobalData">getGlobalData</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForMessage">getPrefixesForMessage</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForServer">getPrefixesForServer</a></li><li data-type='method'><a href="Persistence.html#getPrimaryPrefixForMessage">getPrimaryPrefixForMessage</a></li><li data-type='method'><a href="Persistence.html#resetPrefixesForServerId">resetPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#stop">stop</a></li></ul></li><li><a href="Settings.html">Settings</a><ul class='methods'><li data-type='method'><a href="Settings.html#getInternalSettingValue">getInternalSettingValue</a></li><li data-type='method'><a href="Settings.html#getRawSettingsTree">getRawSettingsTree</a></li><li data-type='method'><a href="Settings.html#getTreeNodeForUniqueId">getTreeNodeForUniqueId</a></li><li data-type='method'><a href="Settings.html#getUserFacingSettingValue">getUserFacingSettingValue</a></li><li data-type='method'><a href="Settings.html#setChannelSettingValue">setChannelSettingValue</a></li><li data-type='method'><a href="Settings.html#setServerWideSettingValue">setServerWideSettingValue</a></li><li data-type='method'><a href="Settings.html#setUserSettingValue">setUserSettingValue</a></li><li data-type='method'><a href="Settings.html#userFacingValueIsValidForSetting">userFacingValueIsValidForSetting</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-_Eris.Client_.html">Eris.Client</a></li><li><a href="external-_Eris.Message_.html">Eris.Message</a></li><li><a href="external-_Eris.TextChannel_.html">Eris.TextChannel</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">logger.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const AnsiColor = require('./util/ansi_color_codes.js');
const LogMessageBuilder = require('./util/log_message_builder');
const mkdirpSync = require('mkdirp').sync;
const path = require('path');
const LOGGER_TITLE = 'LOGGER';

const LOG_FILE_PREFIX = 'log_';

function addPrecedingZero(timeString) {
  if (timeString.length === 1) {
    return `0${timeString}`;
  }
  return timeString;
}

function createTimestamp() {
  let now = new Date();
  let year = now.getFullYear().toString();
  let month = (now.getMonth() + 1).toString();
  let day = now.getDate().toString();
  let hour = now.getHours().toString();
  let minute = now.getMinutes().toString();
  let second = now.getSeconds().toString();
  hour = addPrecedingZero(hour);
  minute = addPrecedingZero(minute);
  second = addPrecedingZero(second);
  return `[${month}/${day}/${year} ${hour}:${minute}:${second}]`;
}

/**
 * Log events to the console and to the log file.
 * The Logger can be
 * accessed via {@link Monochrome#getLogger}.
 * @hideconstructor
 */
class Logger {
  constructor(logDirectoryPath, useAnsiColorsInLogFile, consoleOverride) {
    this.console_ = consoleOverride || console;
    this.closed = false;
    this.logToFile_ = !!logDirectoryPath;
    this.userAnsiColorsInLogFile_ = !!useAnsiColorsInLogFile;

    if (this.logToFile_) {
      try {
        mkdirpSync(logDirectoryPath);
      } catch (err) {
        this.console_.warn(`Error creating log directory: ${err}. Disabling logging to file.`);
        this.logToFile_ = false;
      }

      let logFilePath = path.join(logDirectoryPath, `${LOG_FILE_PREFIX}${new Date().toISOString()}.log`);
      this.fileStream_ = fs.createWriteStream(logFilePath);
      this.fileStream_.on('error', (err) => {
        this.logToFile_ = false;
        this.logFailure(LOGGER_TITLE, 'Error logging to file. Disabling logging to file.', err);
      });
    }
  }

  logInputReaction(title, msg, inputReactorTitle, succeeded, failureMessage) {
    let turnAroundTimeMs = Date.now() - msg.timestamp;
    let logMessageBuilder = new LogMessageBuilder();
    logMessageBuilder.setColor(AnsiColor.YELLOW);
    if (msg.channel.guild) {
      logMessageBuilder.append(msg.channel.guild.name);
      logMessageBuilder.setColor(AnsiColor.RESET);
      logMessageBuilder.append(' >> ');
      logMessageBuilder.setColor(AnsiColor.YELLOW);
      logMessageBuilder.append(msg.channel.name);
      logMessageBuilder.setColor(AnsiColor.RESET);
      logMessageBuilder.append(' >> ');
    }
    logMessageBuilder.setColor(AnsiColor.BLUE);
    logMessageBuilder.append(msg.author.username);
    logMessageBuilder.append('#');
    logMessageBuilder.append(msg.author.discriminator);
    logMessageBuilder.setColor(AnsiColor.RESET);
    logMessageBuilder.append(' >> ');
    if (inputReactorTitle) {
      logMessageBuilder.append(`[${inputReactorTitle}]`);
      logMessageBuilder.append(' ');
    }
    logMessageBuilder.setColor(AnsiColor.MAGENTA);
    logMessageBuilder.append(msg.content);

    if (succeeded) {
      logMessageBuilder.setColor(AnsiColor.RESET);
      logMessageBuilder.append(' ');
      logMessageBuilder.append(`(${turnAroundTimeMs}ms turnaround)`);
    }

    if (succeeded) {
      this.logSuccess(title, logMessageBuilder);
    } else {
      if (failureMessage) {
        logMessageBuilder.setColor(AnsiColor.RED);
        logMessageBuilder.append(' ');
        logMessageBuilder.append(`FAILED (${failureMessage})`);
      }
      this.logFailure(title, logMessageBuilder);
    }
  }

  /**
   * Log a message with a successful green color.
   * @param {string} title - The title of the message to log.
   * @param {string} message - The body of the message to log.
   */
  logSuccess(title, message) {
    this.checkState_();
    this.logMessage(title, '\u001b[32m', message);
  }

  /**
   * Log a message with an unsuccessful red color.
   * @param {string} title - The title of the message to log.
   * @param {string} message - The body of the message to log.
   * @param {Error} [err] - The exception that occurred, if applicable. Its stack trace will be logged.
   */
  logFailure(title, message, err) {
    this.checkState_();
    this.logMessage(title, '\u001b[31m', message, err);
  }

  logMessage(title, titleColor, message, err) {
    this.checkState_();

    let messageBuilder = new LogMessageBuilder();
    let timeStamp = createTimestamp();
    messageBuilder.append(timeStamp);
    messageBuilder.append(' ');
    messageBuilder.setColor(titleColor);
    messageBuilder.append(title);
    messageBuilder.append(' ');
    messageBuilder.setColor(AnsiColor.RESET);
    messageBuilder.append(message);
    messageBuilder.setColor(AnsiColor.RESET);

    if (err &amp;&amp; err.stack) {
      messageBuilder.append(' ');
      messageBuilder.setColor(AnsiColor.RED);
      messageBuilder.append(err.stack);
      messageBuilder.setColor(AnsiColor.RESET);
    }

    const messageWithFormatting = messageBuilder.getMessageWithFormatting();
    this.console_.log(messageWithFormatting);

    if (this.logToFile_) {
      if (this.useAnsiColorsInLogFile) {
        this.fileStream_.write(`${messageWithFormatting}\n`);
      } else {
        this.fileStream_.write(`${messageBuilder.getMessageWithoutFormatting()}\n`);
      }
    }
  }

  close() {
    if (this.closed) {
      return Promise.resolve();
    }

    this.closed = true;

    return new Promise((fulfill, reject) => {
      if (!this.fileStream_) {
        fulfill();
      } else {
        this.fileStream_.end(err => {
          if (err) {
            this.console_.warn('Error closing log stream');
            return reject(err);
          }
          return fulfill();
        });
      }
    });
  }

  checkState_() {
    if (this.closed) {
      throw new Error('The logger has been closed');
    }
  }
}

module.exports = Logger;
module.exports.LOG_FILE_PREFIX = LOG_FILE_PREFIX;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Apr 08 2019 21:25:49 GMT+0700 (GMT+07:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
